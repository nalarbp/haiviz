{"ast":null,"code":"var _this = this,\n    _jsxFileName = \"/Volumes/DATA/BUDI/APP_DEV/haiviz-v04/src/page_createMap/chart_MapEditor_svg.js\";\n\n/* ============================================================================\n============================================================================ */\nimport React, { useEffect, useRef, useCallback } from \"react\";\nimport { useHistory } from \"react-router-dom\";\nimport { select } from \"d3-selection\";\nimport { Col, Button, Input } from \"antd\";\nimport { zoom } from \"d3-zoom\";\nimport { drag } from \"d3-drag\";\nimport { v1 as uuidv1 } from \"uuid\";\nimport { event as currentEvent } from \"d3\";\nimport \"./style_CreateMap.css\";\nimport withMeasure from \"../hocs/withMeasure\";\nimport buildHAIvizXML from \"../utils/buildXML\";\nimport { downloadFileAsText } from \"../utils/utils\";\nimport { DownloadOutlined, ZoomInOutlined, ZoomOutOutlined, PlusCircleOutlined, CompassOutlined, DeleteOutlined, UploadOutlined } from \"@ant-design/icons\";\nvar dimensions = [\"width\", \"height\"]; //props.svgMap props.height, props.width, props.locationData, props.setlocationData\n\nvar MapEditorChart = function MapEditorChart(props) {\n  //NAV states\n  var history = useHistory();\n  var navToHAIvizAppHandler = useCallback(function () {\n    return history.push(\"/haiviz-spa\");\n  }, [history]); //INTERNAL STATES\n\n  var initalLocationData = props.locationData ? props.locationData : []; //DATA PREP\n\n  var locationDataRef = useRef(initalLocationData);\n  var activeLocationRef = useRef(null);\n  var tableData = useRef(null); //DRAWING CONSTRUCTOR\n\n  var mapeditorSVGRef = useRef();\n  var mapeditorContainerRef = useRef();\n  var mapeditorTableContainerRef = useRef();\n  var observedWidth = props.width ? props.width - 10 : null; //arbitary width so that cause negative\n\n  var observedHeight = props.height ? props.height - 80 : null;\n  var container = select(mapeditorContainerRef.current);\n  var tableContainer = select(mapeditorTableContainerRef.current);\n  var svg = select(mapeditorSVGRef.current);\n  var externalSVGnode = props.svgMap.cloneNode(true);\n  externalSVGnode.setAttribute(\"id\", \"externalSVG\");\n  var container_w = observedWidth;\n  var container_h = observedHeight; //USE EFFECTS\n\n  useEffect(function () {\n    if (props.locationData && initalLocationData) {\n      if (locationDataRef.current.length === 0) {\n        locationDataRef.current = props.locationData;\n        draw();\n      }\n\n      draw();\n    }\n  }, [props.locationData, initalLocationData]);\n  useEffect(function () {\n    if (observedWidth && observedHeight && props.svgMap) {\n      draw();\n    }\n  }, [observedWidth, observedHeight, props.svgMap]); //DRAWING\n\n  function draw() {\n    var svg = select(mapeditorSVGRef.current);\n    svg.attr(\"width\", container_w).attr(\"height\", container_h);\n    var svgBaseGroup = svg.select(\"#mapeditor-base-g\");\n    var baseMapCount = svgBaseGroup.node().childElementCount;\n\n    if (baseMapCount !== 0) {\n      var child = svgBaseGroup.node().firstChild;\n      svgBaseGroup.node().removeChild(child);\n      svgBaseGroup.node().appendChild(externalSVGnode);\n    } else {\n      svgBaseGroup.node().appendChild(externalSVGnode);\n    } //Draw initial location marker\n\n\n    var markerBaseGroup = svg.select(\"#location-marker-g\");\n    updateLocationMarker(); //Draw initial table location\n\n    updateTable(); // == ADDING NEW LOCATION ==\n    // Button\n\n    container.select(\"#map-editor-addLocation\").on(\"click\", function () {\n      var uniqueid = uuidv1();\n      var newLocation = {\n        id: uniqueid,\n        x: 200,\n        y: 240,\n        active: false,\n        name: \"Location-name\"\n      };\n      var isDuplicatedRecords = locationDataRef.current.find(function (d) {\n        return d.name === newLocation.name;\n      }) ? true : false;\n\n      if (!isDuplicatedRecords) {\n        locationDataRef.current.push(newLocation);\n        updateLocationMarker();\n        updateTable();\n      } else {\n        alert(\"Location with name \" + newLocation.name + \" is exist. Please update the name first\");\n      }\n    }); // == REMOVING NEW LOCATION ==\n    // Button\n\n    container.select(\"#map-editor-removeLocation\").on(\"click\", function () {\n      if (activeLocationRef.current) {\n        var filteredLocation = locationDataRef.current.filter(function (d) {\n          return activeLocationRef.current.id !== d.id;\n        });\n        locationDataRef.current = filteredLocation;\n        updateLocationMarker();\n        updateTable();\n      }\n    });\n\n    function clickedMarkerHandler(d) {\n      markerBaseGroup.selectAll(\".map-editor-markers\").attr(\"fill\", \"blue\");\n      select(this).attr(\"fill\", \"red\");\n      var activeLocClone = Object.assign({}, d);\n      activeLocationRef.current = activeLocClone;\n      updateTable();\n    }\n\n    function dragged(d) {\n      select(this).attr(\"cx\", d.x = currentEvent.x).attr(\"cy\", d.y = currentEvent.y);\n    }\n\n    function dragended(d) {\n      updateTable();\n    } //UPDATE FUNCTIONS\n\n\n    function updateLocationMarker() {\n      markerBaseGroup.selectAll(\".map-editor-markers\").remove(); //red-draw\n\n      markerBaseGroup.selectAll(\".map-editor-markers\").data(locationDataRef.current).enter().append(\"circle\").attr(\"class\", \"map-editor-markers\").attr(\"cx\", function (d) {\n        return d.x;\n      }).attr(\"cy\", function (d) {\n        return d.y;\n      }).attr(\"r\", 10).attr(\"fill\", \"blue\").style(\"opacity\", \"0.5\").on(\"click\", clickedMarkerHandler).call(drag().on(\"drag\", dragged).on(\"end\", dragended));\n    }\n\n    function updateTable() {\n      tableData.current = locationDataRef.current.map(function (d) {\n        return {\n          id: d.id,\n          name: d.name,\n          x: Math.floor(d.x),\n          y: Math.floor(d.y)\n        };\n      });\n      tableContainer.select(\"#map-editor-table-viewer tbody\").remove();\n      var tableViewer_tr = tableContainer.select(\"#map-editor-table-viewer\").append(\"tbody\").selectAll(\"tr\").data(tableData.current).enter().append(\"tr\");\n      tableViewer_tr.selectAll(\"td\").data(function (d, i) {\n        return [d.name, d.x, d.y];\n      }).enter().append(\"td\").style(\"background-color\", function (d) {\n        if (activeLocationRef.current && activeLocationRef.current.name === d) {\n          return \"pink\";\n        } else {\n          return \"white\";\n        }\n      }).text(function (d) {\n        return d;\n      });\n    } // AUXILARY FUNCTIONALITIES\n    // == LOCATION NAME UPDATE ==\n\n\n    container.select(\"#marker-update-button\").on(\"click\", function () {\n      if (activeLocationRef.current) {\n        var activeLocIdx = locationDataRef.current.findIndex(function (d) {\n          return d.id === activeLocationRef.current.id;\n        });\n        var isDuplicatedRecords = locationDataRef.current.find(function (d) {\n          return d.name === activeLocationRef.current.name;\n        }) ? true : false;\n\n        if (!isDuplicatedRecords) {\n          locationDataRef.current[activeLocIdx].name = activeLocationRef.current.name;\n          updateTable();\n        } else {\n          alert(\"Location with name \" + activeLocationRef.current.name + \" is exist. Duplication is not allowed\");\n        }\n      }\n    }); // == ZOOM ==\n\n    var zoomHandler = zoom().scaleExtent([0.1, 8]).on(\"zoom\", function () {\n      //select svg group root and transform using zoomstate\n      select(\"#mapeditor-svg-gRoot\").attr(\"transform\", currentEvent.transform);\n    }).filter(function () {\n      return !currentEvent.button && currentEvent.type !== \"wheel\";\n    }); //Zoom in button\n\n    container.select(\"#map-editor-zoomIn\").on(\"click\", function () {\n      zoomHandler.scaleBy(svg.transition().duration(500), 1.5);\n    }); //Zoom out\n\n    container.select(\"#map-editor-zoomOut\").on(\"click\", function () {\n      zoomHandler.scaleBy(svg.transition().duration(500), 0.5);\n    }); // == MAP DOWNLOAD ==\n\n    container.select(\"#download-map-button\").on(\"click\", function () {\n      if (locationDataRef.current.length === 0) {\n        alert(\"Location data is empty, please add one\");\n        return;\n      }\n\n      var svgMapClone = externalSVGnode.cloneNode(true);\n      var haivizXML = buildHAIvizXML(svgMapClone, locationDataRef.current);\n      downloadFileAsText(\"haivizMap.xml\", haivizXML);\n    }); // == MAP UPLOAD TO HAIVIZ ==\n\n    container.select(\"#load-map-button\").on(\"click\", function () {\n      if (locationDataRef.current.length === 0) {\n        alert(\"Location data is empty, please add one\");\n        return;\n      }\n\n      var svgMapClone = externalSVGnode.cloneNode(true);\n      var haivizXML_str = buildHAIvizXML(svgMapClone, locationDataRef.current); // haivizXML is string\n\n      var xmlParser = new DOMParser();\n      var haivizXML = xmlParser.parseFromString(haivizXML_str, \"text/xml\");\n\n      if (props.isolateData) {\n        props.loadXML(haivizXML);\n        navToHAIvizAppHandler();\n        props.changeNavLocation(\"haivizApp\");\n      } else {\n        alert(\"No isolate metadata is loaded on HAIviz. Please load the metadata first\");\n      }\n    });\n    svg.call(zoomHandler);\n  }\n\n  return /*#__PURE__*/React.createElement(React.Fragment, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 305,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(Col, {\n    id: \"map-editor-map\",\n    xs: 24,\n    lg: 17,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 306,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    id: \"map-editor-container\",\n    ref: mapeditorContainerRef,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 307,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    id: \"marker-update-container\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 308,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(Input, {\n    id: \"marker-update-input\",\n    placeholder: activeLocationRef.current ? activeLocationRef.current : \"Location name\",\n    onChange: function onChange(e) {\n      if (activeLocationRef.current) {\n        activeLocationRef.current.name = e.target.value;\n      }\n    },\n    prefix: /*#__PURE__*/React.createElement(CompassOutlined, {\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 321,\n        columnNumber: 23\n      }\n    }),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 309,\n      columnNumber: 13\n    }\n  }), /*#__PURE__*/React.createElement(Button, {\n    block: true,\n    id: \"marker-update-button\",\n    type: \"primary\",\n    size: \"medium\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 323,\n      columnNumber: 13\n    }\n  }, \"Update location's name\"), /*#__PURE__*/React.createElement(Button, {\n    id: \"download-map-button\",\n    type: \"danger\",\n    shape: \"round\",\n    icon: /*#__PURE__*/React.createElement(DownloadOutlined, {\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 336,\n        columnNumber: 21\n      }\n    }),\n    size: \"medium\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 332,\n      columnNumber: 13\n    }\n  }, \"Download final map\"), /*#__PURE__*/React.createElement(Button, {\n    id: \"load-map-button\",\n    shape: \"round\",\n    icon: /*#__PURE__*/React.createElement(UploadOutlined, {\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 345,\n        columnNumber: 21\n      }\n    }),\n    size: \"medium\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 342,\n      columnNumber: 13\n    }\n  }, \"Load map to HAIviz\")), /*#__PURE__*/React.createElement(\"div\", {\n    id: \"map-editor-buttons-container\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 351,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    style: {\n      width: \"35px\",\n      margin: \"20px auto\"\n    },\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 352,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    title: \"Zoom in\",\n    shape: \"circle\",\n    id: \"map-editor-zoomIn\",\n    size: \"medium\",\n    icon: /*#__PURE__*/React.createElement(ZoomInOutlined, {\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 358,\n        columnNumber: 23\n      }\n    }),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 353,\n      columnNumber: 15\n    }\n  }), /*#__PURE__*/React.createElement(Button, {\n    title: \"Zoom out\",\n    shape: \"circle\",\n    id: \"map-editor-zoomOut\",\n    size: \"medium\",\n    icon: /*#__PURE__*/React.createElement(ZoomOutOutlined, {\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 365,\n        columnNumber: 23\n      }\n    }),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 360,\n      columnNumber: 15\n    }\n  })), /*#__PURE__*/React.createElement(\"div\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 368,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    title: \"Add location\",\n    shape: \"circle\",\n    id: \"map-editor-addLocation\",\n    size: \"medium\",\n    icon: /*#__PURE__*/React.createElement(PlusCircleOutlined, {\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 374,\n        columnNumber: 23\n      }\n    }),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 369,\n      columnNumber: 15\n    }\n  })), /*#__PURE__*/React.createElement(\"div\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 377,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    title: \"Remove location\",\n    shape: \"circle\",\n    id: \"map-editor-removeLocation\",\n    size: \"medium\",\n    icon: /*#__PURE__*/React.createElement(DeleteOutlined, {\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 383,\n        columnNumber: 23\n      }\n    }),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 378,\n      columnNumber: 15\n    }\n  }))), /*#__PURE__*/React.createElement(\"svg\", {\n    id: \"mapeditor-svg\",\n    ref: mapeditorSVGRef,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 387,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(\"g\", {\n    id: \"mapeditor-svg-gRoot\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 388,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(\"g\", {\n    id: \"mapeditor-base-g\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 389,\n      columnNumber: 15\n    }\n  }), /*#__PURE__*/React.createElement(\"g\", {\n    id: \"location-marker-g\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 390,\n      columnNumber: 15\n    }\n  }))))), /*#__PURE__*/React.createElement(Col, {\n    id: \"map-editor-tables\",\n    xs: 24,\n    lg: 7,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 395,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    ref: mapeditorTableContainerRef,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 396,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(\"table\", {\n    id: \"map-editor-table-viewer\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 397,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(\"thead\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 398,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(\"tr\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 399,\n      columnNumber: 15\n    }\n  }, /*#__PURE__*/React.createElement(\"th\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 400,\n      columnNumber: 17\n    }\n  }, \"Name\"), /*#__PURE__*/React.createElement(\"th\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 401,\n      columnNumber: 17\n    }\n  }, \"x\"), /*#__PURE__*/React.createElement(\"th\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 402,\n      columnNumber: 17\n    }\n  }, \"y\"))), /*#__PURE__*/React.createElement(\"tbody\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 405,\n      columnNumber: 13\n    }\n  })))));\n};\n\nvar MapEditorChartContainer = function MapEditorChartContainer(props) {\n  return /*#__PURE__*/React.createElement(React.Fragment, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 415,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(MapEditorChart, {\n    svgMap: props.svgMap,\n    loadLocationData: props.loadLocationData,\n    locationData: props.locationData,\n    width: props.width,\n    height: props.height,\n    isolateData: props.isolateData,\n    loadXML: props.loadXML,\n    changeNavLocation: props.changeNavLocation,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 416,\n      columnNumber: 7\n    }\n  }));\n};\n\nvar MeasuredMapEditorChartContainer = withMeasure(dimensions)(MapEditorChartContainer);\nexport default MeasuredMapEditorChartContainer;\n/*\n<Button\n  id={\"load-map-button\"}\n  shape=\"round\"\n  icon={<DownloadOutlined />}\n  size={\"medium\"}\n>\n  Load map to HAIviz\n</Button>\n*/","map":{"version":3,"sources":["/Volumes/DATA/BUDI/APP_DEV/haiviz-v04/src/page_createMap/chart_MapEditor_svg.js"],"names":["React","useEffect","useRef","useCallback","useHistory","select","Col","Button","Input","zoom","drag","v1","uuidv1","event","currentEvent","withMeasure","buildHAIvizXML","downloadFileAsText","DownloadOutlined","ZoomInOutlined","ZoomOutOutlined","PlusCircleOutlined","CompassOutlined","DeleteOutlined","UploadOutlined","dimensions","MapEditorChart","props","history","navToHAIvizAppHandler","push","initalLocationData","locationData","locationDataRef","activeLocationRef","tableData","mapeditorSVGRef","mapeditorContainerRef","mapeditorTableContainerRef","observedWidth","width","observedHeight","height","container","current","tableContainer","svg","externalSVGnode","svgMap","cloneNode","setAttribute","container_w","container_h","length","draw","attr","svgBaseGroup","baseMapCount","node","childElementCount","child","firstChild","removeChild","appendChild","markerBaseGroup","updateLocationMarker","updateTable","on","uniqueid","newLocation","id","x","y","active","name","isDuplicatedRecords","find","d","alert","filteredLocation","filter","clickedMarkerHandler","selectAll","activeLocClone","Object","assign","dragged","dragended","remove","data","enter","append","style","call","map","Math","floor","tableViewer_tr","i","text","activeLocIdx","findIndex","zoomHandler","scaleExtent","transform","button","type","scaleBy","transition","duration","svgMapClone","haivizXML","haivizXML_str","xmlParser","DOMParser","parseFromString","isolateData","loadXML","changeNavLocation","e","target","value","margin","MapEditorChartContainer","loadLocationData","MeasuredMapEditorChartContainer"],"mappings":"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","sourcesContent":["/* ============================================================================\n============================================================================ */\nimport React, { useEffect, useRef, useCallback } from \"react\";\nimport { useHistory } from \"react-router-dom\";\nimport { select } from \"d3-selection\";\nimport { Col, Button, Input } from \"antd\";\nimport { zoom } from \"d3-zoom\";\nimport { drag } from \"d3-drag\";\nimport { v1 as uuidv1 } from \"uuid\";\nimport { event as currentEvent } from \"d3\";\nimport \"./style_CreateMap.css\";\nimport withMeasure from \"../hocs/withMeasure\";\nimport buildHAIvizXML from \"../utils/buildXML\";\nimport { downloadFileAsText } from \"../utils/utils\";\nimport {\n  DownloadOutlined,\n  ZoomInOutlined,\n  ZoomOutOutlined,\n  PlusCircleOutlined,\n  CompassOutlined,\n  DeleteOutlined,\n  UploadOutlined,\n} from \"@ant-design/icons\";\n\nconst dimensions = [\"width\", \"height\"];\n\n//props.svgMap props.height, props.width, props.locationData, props.setlocationData\nconst MapEditorChart = (props) => {\n  //NAV states\n  const history = useHistory();\n  const navToHAIvizAppHandler = useCallback(() => history.push(\"/haiviz-spa\"), [\n    history,\n  ]);\n  //INTERNAL STATES\n  const initalLocationData = props.locationData ? props.locationData : [];\n\n  //DATA PREP\n  const locationDataRef = useRef(initalLocationData);\n  const activeLocationRef = useRef(null);\n  const tableData = useRef(null);\n\n  //DRAWING CONSTRUCTOR\n  const mapeditorSVGRef = useRef();\n  const mapeditorContainerRef = useRef();\n  const mapeditorTableContainerRef = useRef();\n\n  const observedWidth = props.width ? props.width - 10 : null; //arbitary width so that cause negative\n  const observedHeight = props.height ? props.height - 80 : null;\n  const container = select(mapeditorContainerRef.current);\n  const tableContainer = select(mapeditorTableContainerRef.current);\n\n  const svg = select(mapeditorSVGRef.current);\n  const externalSVGnode = props.svgMap.cloneNode(true);\n  externalSVGnode.setAttribute(\"id\", \"externalSVG\");\n  const container_w = observedWidth;\n  const container_h = observedHeight;\n\n  //USE EFFECTS\n  useEffect(() => {\n    if (props.locationData && initalLocationData) {\n      if (locationDataRef.current.length === 0) {\n        locationDataRef.current = props.locationData;\n        draw();\n      }\n      draw();\n    }\n  }, [props.locationData, initalLocationData]);\n  useEffect(() => {\n    if (observedWidth && observedHeight && props.svgMap) {\n      draw();\n    }\n  }, [observedWidth, observedHeight, props.svgMap]);\n\n  //DRAWING\n  function draw() {\n    const svg = select(mapeditorSVGRef.current);\n    svg.attr(\"width\", container_w).attr(\"height\", container_h);\n    let svgBaseGroup = svg.select(\"#mapeditor-base-g\");\n    let baseMapCount = svgBaseGroup.node().childElementCount;\n    if (baseMapCount !== 0) {\n      let child = svgBaseGroup.node().firstChild;\n      svgBaseGroup.node().removeChild(child);\n      svgBaseGroup.node().appendChild(externalSVGnode);\n    } else {\n      svgBaseGroup.node().appendChild(externalSVGnode);\n    }\n\n    //Draw initial location marker\n    let markerBaseGroup = svg.select(\"#location-marker-g\");\n    updateLocationMarker();\n\n    //Draw initial table location\n    updateTable();\n\n    // == ADDING NEW LOCATION ==\n    // Button\n    container.select(\"#map-editor-addLocation\").on(\"click\", () => {\n      const uniqueid = uuidv1();\n      const newLocation = {\n        id: uniqueid,\n        x: 200,\n        y: 240,\n        active: false,\n        name: \"Location-name\",\n      };\n      const isDuplicatedRecords = locationDataRef.current.find(\n        (d) => d.name === newLocation.name\n      )\n        ? true\n        : false;\n      if (!isDuplicatedRecords) {\n        locationDataRef.current.push(newLocation);\n        updateLocationMarker();\n        updateTable();\n      } else {\n        alert(\n          \"Location with name \" +\n            newLocation.name +\n            \" is exist. Please update the name first\"\n        );\n      }\n    });\n\n    // == REMOVING NEW LOCATION ==\n    // Button\n    container.select(\"#map-editor-removeLocation\").on(\"click\", () => {\n      if (activeLocationRef.current) {\n        let filteredLocation = locationDataRef.current.filter(\n          (d) => activeLocationRef.current.id !== d.id\n        );\n        locationDataRef.current = filteredLocation;\n        updateLocationMarker();\n        updateTable();\n      }\n    });\n\n    function clickedMarkerHandler(d) {\n      markerBaseGroup.selectAll(\".map-editor-markers\").attr(\"fill\", \"blue\");\n      select(this).attr(\"fill\", \"red\");\n      let activeLocClone = Object.assign({}, d);\n      activeLocationRef.current = activeLocClone;\n      updateTable();\n    }\n\n    function dragged(d) {\n      select(this)\n        .attr(\"cx\", (d.x = currentEvent.x))\n        .attr(\"cy\", (d.y = currentEvent.y));\n    }\n\n    function dragended(d) {\n      updateTable();\n    }\n\n    //UPDATE FUNCTIONS\n    function updateLocationMarker() {\n      markerBaseGroup.selectAll(\".map-editor-markers\").remove();\n      //red-draw\n      markerBaseGroup\n        .selectAll(\".map-editor-markers\")\n        .data(locationDataRef.current)\n        .enter()\n        .append(\"circle\")\n        .attr(\"class\", \"map-editor-markers\")\n        .attr(\"cx\", (d) => {\n          return d.x;\n        })\n        .attr(\"cy\", (d) => {\n          return d.y;\n        })\n        .attr(\"r\", 10)\n        .attr(\"fill\", \"blue\")\n        .style(\"opacity\", \"0.5\")\n        .on(\"click\", clickedMarkerHandler)\n        .call(\n          drag()\n            .on(\"drag\", dragged)\n            .on(\"end\", dragended)\n        );\n    }\n    function updateTable() {\n      tableData.current = locationDataRef.current.map((d) => {\n        return {\n          id: d.id,\n          name: d.name,\n          x: Math.floor(d.x),\n          y: Math.floor(d.y),\n        };\n      });\n      tableContainer.select(\"#map-editor-table-viewer tbody\").remove();\n      let tableViewer_tr = tableContainer\n        .select(\"#map-editor-table-viewer\")\n        .append(\"tbody\")\n        .selectAll(\"tr\")\n        .data(tableData.current)\n        .enter()\n        .append(\"tr\");\n\n      tableViewer_tr\n        .selectAll(\"td\")\n        .data(function(d, i) {\n          return [d.name, d.x, d.y];\n        })\n        .enter()\n        .append(\"td\")\n        .style(\"background-color\", function(d) {\n          if (\n            activeLocationRef.current &&\n            activeLocationRef.current.name === d\n          ) {\n            return \"pink\";\n          } else {\n            return \"white\";\n          }\n        })\n        .text(function(d) {\n          return d;\n        });\n    }\n\n    // AUXILARY FUNCTIONALITIES\n    // == LOCATION NAME UPDATE ==\n    container.select(\"#marker-update-button\").on(\"click\", () => {\n      if (activeLocationRef.current) {\n        let activeLocIdx = locationDataRef.current.findIndex(function(d) {\n          return d.id === activeLocationRef.current.id;\n        });\n        let isDuplicatedRecords = locationDataRef.current.find(\n          (d) => d.name === activeLocationRef.current.name\n        )\n          ? true\n          : false;\n        if (!isDuplicatedRecords) {\n          locationDataRef.current[activeLocIdx].name =\n            activeLocationRef.current.name;\n          updateTable();\n        } else {\n          alert(\n            \"Location with name \" +\n              activeLocationRef.current.name +\n              \" is exist. Duplication is not allowed\"\n          );\n        }\n      }\n    });\n    // == ZOOM ==\n    const zoomHandler = zoom()\n      .scaleExtent([0.1, 8])\n      .on(\"zoom\", () => {\n        //select svg group root and transform using zoomstate\n        select(\"#mapeditor-svg-gRoot\").attr(\n          \"transform\",\n          currentEvent.transform\n        );\n      })\n      .filter(function() {\n        return !currentEvent.button && currentEvent.type !== \"wheel\";\n      });\n    //Zoom in button\n    container.select(\"#map-editor-zoomIn\").on(\"click\", () => {\n      zoomHandler.scaleBy(svg.transition().duration(500), 1.5);\n    });\n    //Zoom out\n    container.select(\"#map-editor-zoomOut\").on(\"click\", () => {\n      zoomHandler.scaleBy(svg.transition().duration(500), 0.5);\n    });\n\n    // == MAP DOWNLOAD ==\n    container.select(\"#download-map-button\").on(\"click\", () => {\n      if (locationDataRef.current.length === 0) {\n        alert(\"Location data is empty, please add one\");\n        return;\n      }\n      let svgMapClone = externalSVGnode.cloneNode(true);\n      let haivizXML = buildHAIvizXML(svgMapClone, locationDataRef.current);\n\n      downloadFileAsText(\"haivizMap.xml\", haivizXML);\n    });\n\n    // == MAP UPLOAD TO HAIVIZ ==\n    container.select(\"#load-map-button\").on(\"click\", () => {\n      if (locationDataRef.current.length === 0) {\n        alert(\"Location data is empty, please add one\");\n        return;\n      }\n      let svgMapClone = externalSVGnode.cloneNode(true);\n      let haivizXML_str = buildHAIvizXML(svgMapClone, locationDataRef.current); // haivizXML is string\n      let xmlParser = new DOMParser();\n      let haivizXML = xmlParser.parseFromString(haivizXML_str, \"text/xml\");\n      if (props.isolateData) {\n        props.loadXML(haivizXML);\n        navToHAIvizAppHandler();\n        props.changeNavLocation(\"haivizApp\");\n      } else {\n        alert(\n          \"No isolate metadata is loaded on HAIviz. Please load the metadata first\"\n        );\n      }\n    });\n\n    svg.call(zoomHandler);\n  }\n\n  return (\n    <React.Fragment>\n      <Col id=\"map-editor-map\" xs={24} lg={17}>\n        <div id=\"map-editor-container\" ref={mapeditorContainerRef}>\n          <div id=\"marker-update-container\">\n            <Input\n              id={\"marker-update-input\"}\n              placeholder={\n                activeLocationRef.current\n                  ? activeLocationRef.current\n                  : \"Location name\"\n              }\n              onChange={(e) => {\n                if (activeLocationRef.current) {\n                  activeLocationRef.current.name = e.target.value;\n                }\n              }}\n              prefix={<CompassOutlined />}\n            />\n            <Button\n              block={true}\n              id={\"marker-update-button\"}\n              type=\"primary\"\n              size={\"medium\"}\n            >\n              Update location's name\n            </Button>\n\n            <Button\n              id={\"download-map-button\"}\n              type=\"danger\"\n              shape=\"round\"\n              icon={<DownloadOutlined />}\n              size={\"medium\"}\n            >\n              Download final map\n            </Button>\n\n            <Button\n              id={\"load-map-button\"}\n              shape=\"round\"\n              icon={<UploadOutlined />}\n              size={\"medium\"}\n            >\n              Load map to HAIviz\n            </Button>\n          </div>\n          <div id=\"map-editor-buttons-container\">\n            <div style={{ width: \"35px\", margin: \"20px auto\" }}>\n              <Button\n                title={\"Zoom in\"}\n                shape={\"circle\"}\n                id={\"map-editor-zoomIn\"}\n                size={\"medium\"}\n                icon={<ZoomInOutlined />}\n              ></Button>\n              <Button\n                title={\"Zoom out\"}\n                shape={\"circle\"}\n                id={\"map-editor-zoomOut\"}\n                size={\"medium\"}\n                icon={<ZoomOutOutlined />}\n              ></Button>\n            </div>\n            <div>\n              <Button\n                title={\"Add location\"}\n                shape={\"circle\"}\n                id={\"map-editor-addLocation\"}\n                size={\"medium\"}\n                icon={<PlusCircleOutlined />}\n              ></Button>\n            </div>\n            <div>\n              <Button\n                title={\"Remove location\"}\n                shape={\"circle\"}\n                id={\"map-editor-removeLocation\"}\n                size={\"medium\"}\n                icon={<DeleteOutlined />}\n              ></Button>\n            </div>\n          </div>\n          <svg id=\"mapeditor-svg\" ref={mapeditorSVGRef}>\n            <g id=\"mapeditor-svg-gRoot\">\n              <g id=\"mapeditor-base-g\" />\n              <g id=\"location-marker-g\" />\n            </g>\n          </svg>\n        </div>\n      </Col>\n      <Col id=\"map-editor-tables\" xs={24} lg={7}>\n        <div ref={mapeditorTableContainerRef}>\n          <table id=\"map-editor-table-viewer\">\n            <thead>\n              <tr>\n                <th>Name</th>\n                <th>x</th>\n                <th>y</th>\n              </tr>\n            </thead>\n            <tbody></tbody>\n          </table>\n        </div>\n      </Col>\n    </React.Fragment>\n  );\n};\n\nconst MapEditorChartContainer = (props) => {\n  return (\n    <React.Fragment>\n      <MapEditorChart\n        svgMap={props.svgMap}\n        loadLocationData={props.loadLocationData}\n        locationData={props.locationData}\n        width={props.width}\n        height={props.height}\n        isolateData={props.isolateData}\n        loadXML={props.loadXML}\n        changeNavLocation={props.changeNavLocation}\n      />\n    </React.Fragment>\n  );\n};\n\nconst MeasuredMapEditorChartContainer = withMeasure(dimensions)(\n  MapEditorChartContainer\n);\n\nexport default MeasuredMapEditorChartContainer;\n\n/*\n<Button\n  id={\"load-map-button\"}\n  shape=\"round\"\n  icon={<DownloadOutlined />}\n  size={\"medium\"}\n>\n  Load map to HAIviz\n</Button>\n*/\n"]},"metadata":{},"sourceType":"module"}