{"ast":null,"code":"import _slicedToArray from \"@babel/runtime/helpers/esm/slicedToArray\";\n\nvar _this = this,\n    _jsxFileName = \"/Volumes/DATA/BUDI/APP_DEV/haiviz-v04/src/viz_TemporalBar/chart_TemporalBar_stackedBar.js\";\n\n/* ============================================================================\nPROBLEM: D3 brush currentEvent state is interfered by ract grid layout postion\nSo we can only use gid 0,0 and make it non resizeable\n============================================================================ */\nimport React, { useEffect, useRef, useState } from \"react\";\nimport { extent } from \"d3-array\";\nimport { timeFormat } from \"d3-time-format\";\nimport { select } from \"d3-selection\";\nimport { Empty, Button } from \"antd\";\nimport { brushX } from \"d3-brush\";\nimport { scaleLinear, scaleTime } from \"d3-scale\";\nimport { axisBottom, axisLeft } from \"d3-axis\";\nimport { event as currentEvent } from \"d3\";\nimport { filterUnique, getColorScaleByObject } from \"../utils/utils\";\nimport \"./style_TemporalBar.css\";\nimport { PlayCircleOutlined, BorderOutlined } from \"@ant-design/icons\";\n\nvar moment = require(\"moment\");\n\nvar TemporalStackedBar = function TemporalStackedBar(props) {\n  //states\n  var _useState = useState(null),\n      _useState2 = _slicedToArray(_useState, 2),\n      selectionDate = _useState2[0],\n      setselectionDate = _useState2[1];\n\n  var temporalbarSVGRef = useRef();\n  var temporalbarContainerRef = useRef();\n  var animPlayer = useRef([]);\n  var animIsPlaying = useRef(false);\n  var observedWidth = props.width - 10;\n  var observedHeight = props.height - 100; //ofsett by card head\n\n  var svg = select(temporalbarSVGRef.current);\n  var margin = {\n    top: 10,\n    right: 20,\n    bottom: 10,\n    left: 30\n  };\n  var temporalbar_w = observedWidth - margin.left - margin.right;\n  var temporalbar_h = observedHeight - margin.top - margin.bottom - 10; //SETTINGS\n\n  var isUserStartResize = props.temporalbarSettings.isUserStartResize;\n  var scaleMode = props.temporalbarSettings.scaleMode; //const animIsPlaying = props.temporalbarSettings.isAnimationPlaying;\n  //USEEFFECTS\n\n  useEffect(function () {\n    if (!isUserStartResize && !props.isUserRedraw) {\n      draw(); //when initial draw\n    } else if (!isUserStartResize && props.isUserRedraw) {\n      draw(); //when user click redraw\n    } else {\n      //console.log(\"hide and remove\");\n      select(\"#temporalbar-svgGroup\").remove();\n      select(\"#temporalbar-buttons-container\").style(\"display\", \"none\");\n      select(\"#temporalbar-no-drawing\").style(\"display\", \"block\");\n    }\n  }, [observedWidth, observedHeight, props.chartData, isUserStartResize, props.isUserRedraw]);\n  useEffect(function () {\n    if (props.selectedData && props.selectedData.length > 0) {\n      updateBySelectedData();\n    } else if (props.selectedData && props.selectedData.length === 0) {\n      clearSelectedData();\n    }\n  }, [props.selectedData]);\n  useEffect(function () {\n    if (props.colorScale.colorType) {\n      svg.selectAll(\".temporal-bar-rectangle\").attr(\"fill\", function (e) {\n        var obj = props.isolateData.get(e.isolate_name);\n        var col = getColorScaleByObject(obj, props.colorScale);\n        return col;\n      });\n    }\n  }, [props.colorScale]);\n  useEffect(function () {\n    if (selectionDate) {\n      var cont = select(temporalbarContainerRef.current);\n      cont.select(\"#selection-date-text\").text(function () {\n        return \" \" + moment(selectionDate[0]).format(\"D MMMM YYYY\") + \" - \" + moment(selectionDate[1]).format(\"D MMMM YYYY\");\n      });\n    }\n  }, [selectionDate]); //draw function: heavy processes like drawing each data points are here\n\n  function draw() {\n    var svg = select(temporalbarSVGRef.current);\n    var dateArr = Array.from(props.isolateData.values()).map(function (d) {\n      return d.isolate_colDate;\n    });\n    var dateRange = extent(dateArr);\n    var chartDataArr = Array.from(props.chartData.entries());\n    var frequencyRange = extent(chartDataArr.map(function (d) {\n      return d[1].length;\n    }));\n    var barHeight = temporalbar_h / frequencyRange[1]; //clean previous drawing artifacts\n\n    select(\"#temporalbar-svgGroup\").remove();\n    select(\"#temporalbar-buttons-container\").style(\"display\", \"block\");\n    select(\"#temporalbar-no-drawing\").style(\"display\", \"none\"); //set svg attributes\n\n    svg.attr(\"width\", temporalbar_w + margin.left + margin.right).attr(\"height\", temporalbar_h + margin.top + margin.bottom); //scale\n\n    var scale_x = scaleTime().domain([moment(dateRange[0]).subtract(2, \"weeks\"), moment(dateRange[1]).add(2, \"weeks\")]).range([0, temporalbar_w]); //.nice(); -> make to inconsistent scale offset, without it we have consistent offset that is 1 week before and after\n\n    var scale_y = scaleLinear().domain([0, frequencyRange[1]]).range([temporalbar_h, 0]); //axis\n\n    var axis_x = axisBottom().scale(scale_x).tickSize([5]).tickFormat(timeFormat(\"%Y-%m\"));\n    var axis_y = axisLeft().scale(scale_y).tickSize([5]); //animation\n\n    var animDateIntervalMilliseconds = dateArr.map(function (d) {\n      return d.getTime();\n    }).filter(filterUnique);\n    var animDateInterval = animDateIntervalMilliseconds.map(function (d) {\n      return new Date(d);\n    }).sort(function (a, b) {\n      return a - b;\n    }); //console.log(animDateInterval);\n\n    var pointInInterval = 0; //brush area\n\n    var brush = brushX() // brush rectangle area for mini chart\n    .extent([[0, 0], [temporalbar_w, temporalbar_h]]) // brush region from top left corner 0, 0 to 900, 40\n    .on(\"start\", brushStart).on(\"brush\", brushed).on(\"end\", brushEnd); //make group root of svg for transformation purpose\n\n    var svgGroup = svg.append(\"g\").attr(\"id\", \"temporalbar-svgGroup\").attr(\"transform\", \"translate(\" + margin.left + \",\" + 5 + \")\"); //axis group\n\n    svgGroup.append(\"g\").attr(\"class\", \"temporal-axis axis--x\").attr(\"transform\", \"translate(\" + 0 + \",\" + temporalbar_h + \")\").call(axis_x);\n    svgGroup.append(\"g\").attr(\"class\", \"temporal-axis axis--y\").call(axis_y); //make bar chart group and draw chart on it\n\n    var stackedGroups = svgGroup.append(\"g\").attr(\"id\", \"barchartGroup\").selectAll(\".temporal-bar-group\").data(chartDataArr).enter().append(\"g\").attr(\"class\", \"temporal-bar-group\");\n    var stackedBars = stackedGroups.selectAll(\".temporal-bar-rectangle\").data(function (d) {\n      return d[1];\n    }).enter().append(\"rect\").attr(\"class\", \"temporal-bar-rectangle\").attr(\"y\", function (e, i) {\n      return scale_y(i + 1);\n    }).attr(\"height\", barHeight).attr(\"stroke\", \"black\").attr(\"stroke-width\", \"0.5\").style(\"opacity\", 1).attr(\"fill\", function (e) {\n      var obj = props.isolateData.get(e.isolate_name);\n      var col = getColorScaleByObject(obj, props.colorScale);\n      return col;\n    }); // .on(\"click\", (e) => {\n    //   props.setSelectedData([e.isolate_name]); //not needed\n    // });\n\n    if (scaleMode === \"daily\") {\n      stackedBars.attr(\"x\", function (e) {\n        var day = moment(e.isolate_colDate);\n        var day_begin = day.startOf(\"day\").toString();\n        return scale_x(new Date(day_begin));\n      }).attr(\"width\", function (e) {\n        var day = moment(e.isolate_colDate);\n        var day_begin = day.startOf(\"day\").toString();\n        var day_end = day.endOf(\"day\").toString();\n        return scale_x(new Date(day_end)) - scale_x(new Date(day_begin));\n      }).append(\"title\").text(function (e) {\n        return \"\".concat(e.isolate_name);\n      });\n    } else {\n      stackedBars.attr(\"x\", function (e) {\n        var day = moment(e.isolate_colDate);\n        var isoWk_begin = day.startOf(\"isoWeek\").toString();\n        return scale_x(new Date(isoWk_begin));\n      }).attr(\"width\", function (e) {\n        var day = moment(e.isolate_colDate);\n        var isoWk_begin = day.startOf(\"isoWeek\").toString();\n        var isoWk_end = day.endOf(\"isoWeek\").toString();\n        return scale_x(new Date(isoWk_end)) - scale_x(new Date(isoWk_begin));\n      }).append(\"title\").text(function (e) {\n        return \"\".concat(e.isolate_name);\n      });\n    } //make brush group\n\n\n    var brushAreaGroup = svgGroup.append(\"g\").attr(\"class\", \"temporal-brushArea\").call(brush); // function brushHandle(g, selection) {\n    //   g.selectAll(\".handle--custom\")\n    //     .data([{ type: \"w\" }, { type: \"e\" }])\n    //     .join((enter) =>\n    //       enter\n    //         .append(\"path\")\n    //         .attr(\"class\", \"handle--custom\")\n    //         .attr(\"fill\", \"#666\")\n    //         .attr(\"fill-opacity\", 0)\n    //         .attr(\"stroke\", \"#000\")\n    //         .attr(\"stroke-width\", 1.5)\n    //         .attr(\"cursor\", \"ew-resize\")\n    //         .attr(\"d\", (d) => brushResizePath(d, temporalbar_h))\n    //     )\n    //     .attr(\n    //       \"transform\",\n    //       selection.length === 0\n    //         ? null\n    //         : (d, i) => `translate(${selection[i]},${temporalbar_h / 4})`\n    //     );\n    // }\n\n    function brushStart() {\n      //hide handle\n      if (currentEvent.sourceEvent !== null && animIsPlaying.current) {\n        animPlayer.current.forEach(clearInterval);\n        pointInInterval = 0;\n        animIsPlaying.current = false;\n      } //let selection = currentEvent.selection;\n      // if (selection[0] - selection[1] === 0) {\n      //   brushAreaGroup.selectAll(\".handle--custom\").attr(\"display\", \"none\");\n      // }\n\n    }\n\n    function brushed() {//move handle and highlight selected bar\n      //brushAreaGroup.selectAll(\".handle--custom\").attr(\"display\", \"true\");\n      //let selection = currentEvent.selection;\n      //select(this).call(brushHandle, selection); //move brush handle based on selection\n    }\n\n    function brushEnd() {\n      //when brush is end, do logic here (e.g., filter data)\n      var selection = currentEvent.selection;\n\n      if (selection !== null) {\n        var dateSelection = selection.map(scale_x.invert);\n        svgGroup.selectAll(\".temporal-bar-rectangle\").style(\"opacity\", function (d) {\n          var day = moment(d.isolate_colDate);\n\n          if (day >= dateSelection[0] && day <= dateSelection[1]) {\n            return 1;\n          } else {\n            return 0.2;\n          }\n        });\n        var selectedData = Array.from(props.isolateData.values()).map(function (d) {\n          return d;\n        }).filter(function (d) {\n          return d.isolate_colDate >= dateSelection[0] && d.isolate_colDate <= dateSelection[1];\n        });\n\n        if (selectedData && selectedData.length > 0) {\n          selectedData = selectedData.map(function (d) {\n            return d.uid;\n          });\n          props.setSelectedData(selectedData);\n        }\n\n        setselectionDate(dateSelection);\n      }\n    } // ======================= ANIMATION CONTROLLER ================================\n\n\n    var cont = select(temporalbarContainerRef.current);\n    cont.select(\"#playBtn\").on(\"click\", function () {\n      if (!animIsPlaying.current) {\n        //jika animasi tidak saat dijalankan = FALSE\n        playAnimation();\n      } else {\n        pauseAnimation();\n      }\n    });\n    cont.select(\"#stopBtn\").on(\"click\", function () {\n      if (animIsPlaying.current) {\n        stopAnimation();\n      }\n    }); //when animation is playing never make new set interval\n\n    function playAnimation() {\n      var animPlayer_interval = setInterval(function () {\n        movingBrush();\n      }, 1000);\n      animPlayer.current.push(animPlayer_interval); //set animation is playing = TRUE\n      //change the state on anim is playing\n      //props.changeTempIsAnimationPlaying(true);\n\n      animIsPlaying.current = true;\n    }\n\n    function pauseAnimation() {\n      animPlayer.current.forEach(clearInterval); //props.changeTempIsAnimationPlaying(false);\n\n      animIsPlaying.current = false;\n    }\n\n    function movingBrush() {\n      //console.log(\"moving\");\n      if (animIsPlaying.current && pointInInterval < animDateInterval.length) {\n        var currentDate = pointInInterval === animDateInterval.length - 1 ? moment(animDateInterval[pointInInterval]).add(1, \"day\") : animDateInterval[pointInInterval];\n        brushAreaGroup.call(brush).call(brush.move, [0, scale_x(currentDate)]);\n        pointInInterval += 1;\n      } else {\n        stopAnimation();\n      }\n    }\n\n    function stopAnimation() {\n      animPlayer.current.forEach(clearInterval);\n      pointInInterval = 0; //props.changeTempIsAnimationPlaying(false);\n\n      animIsPlaying.current = false; //console.log(scale_x.range());\n\n      brushAreaGroup.call(brush.move, scale_x.range());\n    }\n\n    brushAreaGroup.call(brush.move, scale_x.range());\n  }\n\n  function updateBySelectedData() {\n    svg.selectAll(\".temporal-bar-rectangle\").style(\"opacity\", function (d) {\n      if (props.selectedData.indexOf(d.uid) !== -1) {\n        return 1;\n      } else {\n        return 0.2;\n      }\n    });\n  }\n\n  function clearSelectedData() {\n    svg.selectAll(\".temporal-bar-rectangle\").style(\"opacity\", 1);\n  }\n\n  return /*#__PURE__*/React.createElement(React.Fragment, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 390,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    id: \"temporalbarContainer\",\n    ref: temporalbarContainerRef,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 391,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    id: \"temporalbar-no-drawing\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 392,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(Empty, {\n    description: \"No chart: please click redraw button\",\n    image: Empty.PRESENTED_IMAGE_SIMPLE,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 393,\n      columnNumber: 11\n    }\n  })), /*#__PURE__*/React.createElement(\"div\", {\n    id: \"temporalbar-buttons-container\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 398,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    id: \"temporalbar-playback\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 399,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    id: \"playBtn\",\n    size: \"medium\",\n    style: {\n      margin: \"0px\",\n      border: \"none\"\n    },\n    icon: /*#__PURE__*/React.createElement(PlayCircleOutlined, {\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 404,\n        columnNumber: 21\n      }\n    }),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 400,\n      columnNumber: 13\n    }\n  }), /*#__PURE__*/React.createElement(Button, {\n    id: \"stopBtn\",\n    size: \"small\",\n    style: {\n      margin: \"0px\",\n      border: \"none\"\n    },\n    icon: /*#__PURE__*/React.createElement(BorderOutlined, {\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 410,\n        columnNumber: 21\n      }\n    }),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 406,\n      columnNumber: 13\n    }\n  })), /*#__PURE__*/React.createElement(\"div\", {\n    id: \"temporalbar-selectedDate\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 414,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(\"p\", {\n    style: {\n      marginLeft: \"10px\"\n    },\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 415,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(\"strong\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 416,\n      columnNumber: 15\n    }\n  }, \"Selected date: \"), /*#__PURE__*/React.createElement(\"span\", {\n    id: \"selection-date-text\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 417,\n      columnNumber: 15\n    }\n  })))), /*#__PURE__*/React.createElement(\"svg\", {\n    id: \"temporalbar-svg\",\n    ref: temporalbarSVGRef,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 421,\n      columnNumber: 9\n    }\n  })));\n};\n\nexport default TemporalStackedBar;","map":{"version":3,"sources":["/Volumes/DATA/BUDI/APP_DEV/haiviz-v04/src/viz_TemporalBar/chart_TemporalBar_stackedBar.js"],"names":["React","useEffect","useRef","useState","extent","timeFormat","select","Empty","Button","brushX","scaleLinear","scaleTime","axisBottom","axisLeft","event","currentEvent","filterUnique","getColorScaleByObject","PlayCircleOutlined","BorderOutlined","moment","require","TemporalStackedBar","props","selectionDate","setselectionDate","temporalbarSVGRef","temporalbarContainerRef","animPlayer","animIsPlaying","observedWidth","width","observedHeight","height","svg","current","margin","top","right","bottom","left","temporalbar_w","temporalbar_h","isUserStartResize","temporalbarSettings","scaleMode","isUserRedraw","draw","remove","style","chartData","selectedData","length","updateBySelectedData","clearSelectedData","colorScale","colorType","selectAll","attr","e","obj","isolateData","get","isolate_name","col","cont","text","format","dateArr","Array","from","values","map","d","isolate_colDate","dateRange","chartDataArr","entries","frequencyRange","barHeight","scale_x","domain","subtract","add","range","scale_y","axis_x","scale","tickSize","tickFormat","axis_y","animDateIntervalMilliseconds","getTime","filter","animDateInterval","Date","sort","a","b","pointInInterval","brush","on","brushStart","brushed","brushEnd","svgGroup","append","call","stackedGroups","data","enter","stackedBars","i","day","day_begin","startOf","toString","day_end","endOf","isoWk_begin","isoWk_end","brushAreaGroup","sourceEvent","forEach","clearInterval","selection","dateSelection","invert","uid","setSelectedData","playAnimation","pauseAnimation","stopAnimation","animPlayer_interval","setInterval","movingBrush","push","currentDate","move","indexOf","PRESENTED_IMAGE_SIMPLE","border","marginLeft"],"mappings":"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","sourcesContent":["/* ============================================================================\nPROBLEM: D3 brush currentEvent state is interfered by ract grid layout postion\nSo we can only use gid 0,0 and make it non resizeable\n============================================================================ */\nimport React, { useEffect, useRef, useState } from \"react\";\nimport { extent } from \"d3-array\";\nimport { timeFormat } from \"d3-time-format\";\nimport { select } from \"d3-selection\";\nimport { Empty, Button } from \"antd\";\nimport { brushX } from \"d3-brush\";\nimport { scaleLinear, scaleTime } from \"d3-scale\";\nimport { axisBottom, axisLeft } from \"d3-axis\";\nimport { event as currentEvent } from \"d3\";\nimport { filterUnique, getColorScaleByObject } from \"../utils/utils\";\nimport \"./style_TemporalBar.css\";\nimport { PlayCircleOutlined, BorderOutlined } from \"@ant-design/icons\";\n\nconst moment = require(\"moment\");\n\nconst TemporalStackedBar = (props) => {\n  //states\n  const [selectionDate, setselectionDate] = useState(null);\n  const temporalbarSVGRef = useRef();\n  const temporalbarContainerRef = useRef();\n  const animPlayer = useRef([]);\n  const animIsPlaying = useRef(false);\n  const observedWidth = props.width - 10;\n  const observedHeight = props.height - 100; //ofsett by card head\n  const svg = select(temporalbarSVGRef.current);\n  const margin = { top: 10, right: 20, bottom: 10, left: 30 };\n  const temporalbar_w = observedWidth - margin.left - margin.right;\n  const temporalbar_h = observedHeight - margin.top - margin.bottom - 10;\n\n  //SETTINGS\n\n  const isUserStartResize = props.temporalbarSettings.isUserStartResize;\n  const scaleMode = props.temporalbarSettings.scaleMode;\n  //const animIsPlaying = props.temporalbarSettings.isAnimationPlaying;\n\n  //USEEFFECTS\n  useEffect(() => {\n    if (!isUserStartResize && !props.isUserRedraw) {\n      draw(); //when initial draw\n    } else if (!isUserStartResize && props.isUserRedraw) {\n      draw(); //when user click redraw\n    } else {\n      //console.log(\"hide and remove\");\n      select(\"#temporalbar-svgGroup\").remove();\n      select(\"#temporalbar-buttons-container\").style(\"display\", \"none\");\n      select(\"#temporalbar-no-drawing\").style(\"display\", \"block\");\n    }\n  }, [\n    observedWidth,\n    observedHeight,\n    props.chartData,\n    isUserStartResize,\n    props.isUserRedraw,\n  ]);\n\n  useEffect(() => {\n    if (props.selectedData && props.selectedData.length > 0) {\n      updateBySelectedData();\n    } else if (props.selectedData && props.selectedData.length === 0) {\n      clearSelectedData();\n    }\n  }, [props.selectedData]);\n\n  useEffect(() => {\n    if (props.colorScale.colorType) {\n      svg.selectAll(\".temporal-bar-rectangle\").attr(\"fill\", (e) => {\n        let obj = props.isolateData.get(e.isolate_name);\n        let col = getColorScaleByObject(obj, props.colorScale);\n        return col;\n      });\n    }\n  }, [props.colorScale]);\n\n  useEffect(() => {\n    if (selectionDate) {\n      const cont = select(temporalbarContainerRef.current);\n      cont.select(\"#selection-date-text\").text(() => {\n        return (\n          \" \" +\n          moment(selectionDate[0]).format(\"D MMMM YYYY\") +\n          \" - \" +\n          moment(selectionDate[1]).format(\"D MMMM YYYY\")\n        );\n      });\n    }\n  }, [selectionDate]);\n\n  //draw function: heavy processes like drawing each data points are here\n  function draw() {\n    const svg = select(temporalbarSVGRef.current);\n    const dateArr = Array.from(props.isolateData.values()).map(\n      (d) => d.isolate_colDate\n    );\n    const dateRange = extent(dateArr);\n    const chartDataArr = Array.from(props.chartData.entries());\n    const frequencyRange = extent(chartDataArr.map((d) => d[1].length));\n    const barHeight = temporalbar_h / frequencyRange[1];\n    //clean previous drawing artifacts\n    select(\"#temporalbar-svgGroup\").remove();\n    select(\"#temporalbar-buttons-container\").style(\"display\", \"block\");\n    select(\"#temporalbar-no-drawing\").style(\"display\", \"none\");\n    //set svg attributes\n    svg\n      .attr(\"width\", temporalbar_w + margin.left + margin.right)\n      .attr(\"height\", temporalbar_h + margin.top + margin.bottom);\n\n    //scale\n    const scale_x = scaleTime()\n      .domain([\n        moment(dateRange[0]).subtract(2, \"weeks\"),\n        moment(dateRange[1]).add(2, \"weeks\"),\n      ])\n      .range([0, temporalbar_w]);\n    //.nice(); -> make to inconsistent scale offset, without it we have consistent offset that is 1 week before and after\n    const scale_y = scaleLinear()\n      .domain([0, frequencyRange[1]])\n      .range([temporalbar_h, 0]);\n\n    //axis\n    const axis_x = axisBottom()\n      .scale(scale_x)\n      .tickSize([5])\n      .tickFormat(timeFormat(\"%Y-%m\"));\n    const axis_y = axisLeft()\n      .scale(scale_y)\n      .tickSize([5]);\n\n    //animation\n    let animDateIntervalMilliseconds = dateArr\n      .map((d) => d.getTime())\n      .filter(filterUnique);\n\n    let animDateInterval = animDateIntervalMilliseconds\n      .map(function(d) {\n        return new Date(d);\n      })\n      .sort(function(a, b) {\n        return a - b;\n      });\n    //console.log(animDateInterval);\n    let pointInInterval = 0;\n\n    //brush area\n    const brush = brushX() // brush rectangle area for mini chart\n      .extent([\n        [0, 0],\n        [temporalbar_w, temporalbar_h],\n      ]) // brush region from top left corner 0, 0 to 900, 40\n      .on(\"start\", brushStart)\n      .on(\"brush\", brushed)\n      .on(\"end\", brushEnd);\n\n    //make group root of svg for transformation purpose\n    let svgGroup = svg\n      .append(\"g\")\n      .attr(\"id\", \"temporalbar-svgGroup\")\n      .attr(\"transform\", \"translate(\" + margin.left + \",\" + 5 + \")\");\n\n    //axis group\n    svgGroup\n      .append(\"g\")\n      .attr(\"class\", \"temporal-axis axis--x\")\n      .attr(\"transform\", \"translate(\" + 0 + \",\" + temporalbar_h + \")\")\n      .call(axis_x);\n    svgGroup\n      .append(\"g\")\n      .attr(\"class\", \"temporal-axis axis--y\")\n      .call(axis_y);\n\n    //make bar chart group and draw chart on it\n    let stackedGroups = svgGroup\n      .append(\"g\")\n      .attr(\"id\", \"barchartGroup\")\n      .selectAll(\".temporal-bar-group\")\n      .data(chartDataArr)\n      .enter()\n      .append(\"g\")\n      .attr(\"class\", \"temporal-bar-group\");\n\n    let stackedBars = stackedGroups\n      .selectAll(\".temporal-bar-rectangle\")\n      .data((d) => d[1])\n      .enter()\n      .append(\"rect\")\n      .attr(\"class\", \"temporal-bar-rectangle\")\n      .attr(\"y\", (e, i) => scale_y(i + 1))\n      .attr(\"height\", barHeight)\n      .attr(\"stroke\", \"black\")\n      .attr(\"stroke-width\", \"0.5\")\n      .style(\"opacity\", 1)\n      .attr(\"fill\", (e) => {\n        let obj = props.isolateData.get(e.isolate_name);\n        let col = getColorScaleByObject(obj, props.colorScale);\n        return col;\n      });\n    // .on(\"click\", (e) => {\n    //   props.setSelectedData([e.isolate_name]); //not needed\n    // });\n\n    if (scaleMode === \"daily\") {\n      stackedBars\n        .attr(\"x\", (e) => {\n          let day = moment(e.isolate_colDate);\n          let day_begin = day.startOf(\"day\").toString();\n          return scale_x(new Date(day_begin));\n        })\n        .attr(\"width\", (e) => {\n          let day = moment(e.isolate_colDate);\n          let day_begin = day.startOf(\"day\").toString();\n          let day_end = day.endOf(\"day\").toString();\n          return scale_x(new Date(day_end)) - scale_x(new Date(day_begin));\n        })\n        .append(\"title\")\n        .text((e) => `${e.isolate_name}`);\n    } else {\n      stackedBars\n        .attr(\"x\", (e) => {\n          let day = moment(e.isolate_colDate);\n          let isoWk_begin = day.startOf(\"isoWeek\").toString();\n          return scale_x(new Date(isoWk_begin));\n        })\n        .attr(\"width\", (e) => {\n          let day = moment(e.isolate_colDate);\n          let isoWk_begin = day.startOf(\"isoWeek\").toString();\n          let isoWk_end = day.endOf(\"isoWeek\").toString();\n          return scale_x(new Date(isoWk_end)) - scale_x(new Date(isoWk_begin));\n        })\n        .append(\"title\")\n        .text((e) => `${e.isolate_name}`);\n    }\n\n    //make brush group\n    let brushAreaGroup = svgGroup\n      .append(\"g\")\n      .attr(\"class\", \"temporal-brushArea\")\n      .call(brush);\n\n    // function brushHandle(g, selection) {\n    //   g.selectAll(\".handle--custom\")\n    //     .data([{ type: \"w\" }, { type: \"e\" }])\n    //     .join((enter) =>\n    //       enter\n    //         .append(\"path\")\n    //         .attr(\"class\", \"handle--custom\")\n    //         .attr(\"fill\", \"#666\")\n    //         .attr(\"fill-opacity\", 0)\n    //         .attr(\"stroke\", \"#000\")\n    //         .attr(\"stroke-width\", 1.5)\n    //         .attr(\"cursor\", \"ew-resize\")\n    //         .attr(\"d\", (d) => brushResizePath(d, temporalbar_h))\n    //     )\n    //     .attr(\n    //       \"transform\",\n    //       selection.length === 0\n    //         ? null\n    //         : (d, i) => `translate(${selection[i]},${temporalbar_h / 4})`\n    //     );\n    // }\n\n    function brushStart() {\n      //hide handle\n      if (currentEvent.sourceEvent !== null && animIsPlaying.current) {\n        animPlayer.current.forEach(clearInterval);\n        pointInInterval = 0;\n        animIsPlaying.current = false;\n      }\n      //let selection = currentEvent.selection;\n      // if (selection[0] - selection[1] === 0) {\n      //   brushAreaGroup.selectAll(\".handle--custom\").attr(\"display\", \"none\");\n      // }\n    }\n\n    function brushed() {\n      //move handle and highlight selected bar\n      //brushAreaGroup.selectAll(\".handle--custom\").attr(\"display\", \"true\");\n      //let selection = currentEvent.selection;\n      //select(this).call(brushHandle, selection); //move brush handle based on selection\n    }\n\n    function brushEnd() {\n      //when brush is end, do logic here (e.g., filter data)\n      let selection = currentEvent.selection;\n      if (selection !== null) {\n        let dateSelection = selection.map(scale_x.invert);\n        svgGroup.selectAll(\".temporal-bar-rectangle\").style(\"opacity\", (d) => {\n          let day = moment(d.isolate_colDate);\n          if (day >= dateSelection[0] && day <= dateSelection[1]) {\n            return 1;\n          } else {\n            return 0.2;\n          }\n        });\n        let selectedData = Array.from(props.isolateData.values())\n          .map((d) => d)\n          .filter(\n            (d) =>\n              d.isolate_colDate >= dateSelection[0] &&\n              d.isolate_colDate <= dateSelection[1]\n          );\n        if (selectedData && selectedData.length > 0) {\n          selectedData = selectedData.map((d) => d.uid);\n          props.setSelectedData(selectedData);\n        }\n\n        setselectionDate(dateSelection);\n      }\n    }\n\n    // ======================= ANIMATION CONTROLLER ================================\n    const cont = select(temporalbarContainerRef.current);\n    cont.select(\"#playBtn\").on(\"click\", () => {\n      if (!animIsPlaying.current) {\n        //jika animasi tidak saat dijalankan = FALSE\n        playAnimation();\n      } else {\n        pauseAnimation();\n      }\n    });\n\n    cont.select(\"#stopBtn\").on(\"click\", () => {\n      if (animIsPlaying.current) {\n        stopAnimation();\n      }\n    });\n\n    //when animation is playing never make new set interval\n\n    function playAnimation() {\n      let animPlayer_interval = setInterval(function() {\n        movingBrush();\n      }, 1000);\n      animPlayer.current.push(animPlayer_interval);\n      //set animation is playing = TRUE\n      //change the state on anim is playing\n      //props.changeTempIsAnimationPlaying(true);\n      animIsPlaying.current = true;\n    }\n\n    function pauseAnimation() {\n      animPlayer.current.forEach(clearInterval);\n      //props.changeTempIsAnimationPlaying(false);\n      animIsPlaying.current = false;\n    }\n\n    function movingBrush() {\n      //console.log(\"moving\");\n      if (animIsPlaying.current && pointInInterval < animDateInterval.length) {\n        var currentDate =\n          pointInInterval === animDateInterval.length - 1\n            ? moment(animDateInterval[pointInInterval]).add(1, \"day\")\n            : animDateInterval[pointInInterval];\n        brushAreaGroup.call(brush).call(brush.move, [0, scale_x(currentDate)]);\n        pointInInterval += 1;\n      } else {\n        stopAnimation();\n      }\n    }\n\n    function stopAnimation() {\n      animPlayer.current.forEach(clearInterval);\n      pointInInterval = 0;\n      //props.changeTempIsAnimationPlaying(false);\n      animIsPlaying.current = false;\n      //console.log(scale_x.range());\n      brushAreaGroup.call(brush.move, scale_x.range());\n    }\n\n    brushAreaGroup.call(brush.move, scale_x.range());\n  }\n\n  function updateBySelectedData() {\n    svg.selectAll(\".temporal-bar-rectangle\").style(\"opacity\", (d) => {\n      if (props.selectedData.indexOf(d.uid) !== -1) {\n        return 1;\n      } else {\n        return 0.2;\n      }\n    });\n  }\n\n  function clearSelectedData() {\n    svg.selectAll(\".temporal-bar-rectangle\").style(\"opacity\", 1);\n  }\n\n  return (\n    <React.Fragment>\n      <div id=\"temporalbarContainer\" ref={temporalbarContainerRef}>\n        <div id=\"temporalbar-no-drawing\">\n          <Empty\n            description={\"No chart: please click redraw button\"}\n            image={Empty.PRESENTED_IMAGE_SIMPLE}\n          />\n        </div>\n        <div id=\"temporalbar-buttons-container\">\n          <div id=\"temporalbar-playback\">\n            <Button\n              id={\"playBtn\"}\n              size={\"medium\"}\n              style={{ margin: \"0px\", border: \"none\" }}\n              icon={<PlayCircleOutlined />}\n            ></Button>\n            <Button\n              id={\"stopBtn\"}\n              size={\"small\"}\n              style={{ margin: \"0px\", border: \"none\" }}\n              icon={<BorderOutlined />}\n            ></Button>\n          </div>\n\n          <div id=\"temporalbar-selectedDate\">\n            <p style={{ marginLeft: \"10px\" }}>\n              <strong>Selected date: </strong>\n              <span id=\"selection-date-text\"></span>\n            </p>\n          </div>\n        </div>\n        <svg id=\"temporalbar-svg\" ref={temporalbarSVGRef}></svg>\n      </div>\n    </React.Fragment>\n  );\n};\n\nexport default TemporalStackedBar;\n"]},"metadata":{},"sourceType":"module"}