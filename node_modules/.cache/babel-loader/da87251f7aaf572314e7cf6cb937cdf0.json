{"ast":null,"code":"var _this = this,\n    _jsxFileName = \"/Volumes/DATA/BUDI/APP_DEV/haiviz-v04/src/viz_Localmap/chart_Localmap_svg.js\";\n\n/* ============================================================================\nNOTE: DONT PUT SIMULATION ON CONSTRUCTOR: it slows down resizing behaviour,\nput it on drawing function instead\n============================================================================ */\nimport React, { useEffect, useRef } from \"react\";\nimport { select } from \"d3-selection\";\nimport { arc, pie } from \"d3-shape\";\nimport { group } from \"d3-array\";\nimport { zoom } from \"d3-zoom\";\nimport { event as currentEvent } from \"d3\";\nimport { Button, Empty } from \"antd\";\nimport \"./style_Localmap.css\";\nimport { getColorScaleByObject, getColumnNameByColorType } from \"../utils/utils\";\nimport { ZoomInOutlined, ZoomOutOutlined, ClearOutlined } from \"@ant-design/icons\";\nimport { forceSimulation, forceCollide, forceManyBody } from \"d3-force\";\n\nvar _ = require(\"lodash\"); //props.data ={xmlsvg, data} svgMap props.height, props.width, props.locationData, props.setlocationData\n\n\nvar LocalmapChart = function LocalmapChart(props) {\n  //INTERNAL STATES/REFS\n  var zoomStateRef = useRef(null);\n  var localmapSVGRef = useRef();\n  var localmapContainerRef = useRef(); //DRAWING CONSTRUCTOR\n\n  var container = select(localmapContainerRef.current);\n  var svg = select(localmapSVGRef.current);\n  var observedWidth = props.width - 10;\n  var observedHeight = props.height - 80;\n  var margin = {\n    top: 10,\n    right: 10,\n    bottom: 10,\n    left: 10\n  };\n  var externalSVGnode = props.data.xmlSVG.cloneNode(true);\n  externalSVGnode.setAttribute(\"id\", \"externalSVG\");\n  var container_w = observedWidth;\n  var container_h = observedHeight;\n\n  var isolateDataClone = _.cloneDeep(Array.from(props.isolateData.values())); //SETTINGS\n\n\n  var isUserStartResize = props.localmapSettings.isUserStartResize;\n  var nodeSize = props.localmapSettings.nodeSize;\n  var textSize = props.localmapSettings.textSize;\n  var textOffset = props.localmapSettings.textOffset;\n  var isLocTextShown = props.localmapSettings.isLocTextShown;\n  var layout = props.localmapSettings.layout; //HELPER FUNCTIONS\n  //USE EFFECTS\n\n  useEffect(function () {\n    if (observedWidth && observedHeight && !isUserStartResize && !props.isUserRedraw) {\n      //when initial draw\n      draw();\n    } else if (observedWidth && observedHeight && !isUserStartResize && props.isUserRedraw) {\n      //when user click redraw\n      draw();\n    } else {\n      select(\"#localmap_svgGroup\").remove();\n      select(\"#localmap-buttons-container\").style(\"display\", \"none\");\n      select(\"#localmap-no-drawing\").style(\"display\", \"block\");\n    }\n  }, [observedWidth, observedHeight, isUserStartResize, props.isUserRedraw]); // === SELECTED DATA ===\n\n  useEffect(function () {\n    if (props.selectedData && props.selectedData.length > 0) {\n      updateBySelectedData();\n    } else if (props.selectedData && props.selectedData.length === 0) {\n      clearSelectedData();\n    }\n  }, [props.selectedData]); // === COLORSCALE ===\n\n  useEffect(function () {\n    if (props.colorScale.colorType) {\n      if (layout === \"scatter\") {\n        svg.selectAll(\".localmap-circle\").attr(\"fill\", function (d) {\n          return getColorScaleByObject(d, props.colorScale);\n        });\n      } else {\n        draw();\n      }\n    }\n  }, [props.colorScale]); // === NODE SIZE ===\n\n  useEffect(function () {\n    if (nodeSize) {\n      if (layout === \"scatter\") {\n        if (props.selectedData && props.selectedData.length > 0) {\n          svg.selectAll(\".localmap-circle\").attr(\"r\", function (d) {\n            return nodeSize;\n          });\n          updateBySelectedData();\n        } else {\n          svg.selectAll(\".localmap-circle\").attr(\"r\", function (d) {\n            return nodeSize;\n          });\n        }\n      } else {\n        draw();\n      }\n    }\n  }, [nodeSize]); // === SHOW TEXT AND TEXT SIZE ===\n\n  useEffect(function () {\n    if (isLocTextShown && textSize) {\n      svg.selectAll(\".localmap-locationLabel\").attr(\"display\", \"block\").attr(\"font-size\", function (d) {\n        return textSize + \"pt\";\n      });\n    } else if (!isLocTextShown) {\n      svg.selectAll(\".localmap-locationLabel\").attr(\"display\", \"none\");\n    }\n  }, [isLocTextShown, textSize]); // === SHOW TEXT AND TEXT OFFSETT ===\n\n  useEffect(function () {\n    if (isLocTextShown && textOffset) {\n      svg.selectAll(\".localmap-locationLabel\").attr(\"display\", \"block\").attr(\"transform\", function (d) {\n        return \"translate(\" + textOffset + \",\" + 0 + \")\";\n      });\n    } else if (!isLocTextShown) {\n      svg.selectAll(\".localmap-locationLabel\").attr(\"display\", \"none\");\n    }\n  }, [isLocTextShown, textOffset]); // === LAYOUT ===\n\n  useEffect(function () {\n    if (layout) {\n      draw();\n    }\n  }, [layout]); //DRAWING\n\n  function draw() {\n    var svg = select(localmapSVGRef.current); //cleaning\n\n    select(\"#localmap-no-drawing\").style(\"display\", \"none\");\n    select(\"#localmap-buttons-container\").style(\"display\", \"block\");\n    select(\"#localmap_svgGroup\").remove(); //svg attributes\n\n    svg.attr(\"width\", container_w).attr(\"height\", container_h); //make svg group root\n\n    var svgGroup = svg.append(\"g\").attr(\"id\", \"localmap_svgGroup\").attr(\"transform\", function (d) {\n      if (zoomStateRef.current) {\n        return \"translate(\" + zoomStateRef.current.x + \",\" + zoomStateRef.current.y + \")\" + \"scale(\" + zoomStateRef.current.k + \")\";\n      } else {\n        return \"translate(\".concat(margin.left, \",\").concat(margin.top, \")scale(1)\");\n      }\n    }); //\"translate(\" + margin.left + \",\" + margin.top + \")\" + \"scale(1)\"\n    //inject externalSVG and scale it\n\n    var svgBaseGroup = svgGroup.append(\"g\").attr(\"id\", \"localmap-base-g\");\n    svgBaseGroup.node().appendChild(externalSVGnode); //add location coordinates\n\n    var locCoordMap = new Map();\n    isolateDataClone.forEach(function (d) {\n      var key = d.isolate_colLocation;\n      var loc_coord = props.data.locationTable.get(d.isolate_colLocation);\n\n      if (loc_coord) {\n        d[\"x\"] = loc_coord.x;\n        d[\"y\"] = loc_coord.y;\n      } else {\n        d[\"x\"] = 0;\n        d[\"y\"] = 0;\n      }\n\n      var val = {\n        locX: d.x,\n        locY: d.y\n      };\n      locCoordMap.set(key, val);\n    });\n    var circlesGroup = svgGroup.append(\"g\").attr(\"id\", \"localmap-circle-g\"); //draw location label\n\n    circlesGroup.selectAll(\".localmap-locationLabel\").data(Array.from(props.data.locationTable.values())).enter().append(\"text\").attr(\"class\", \"localmap-locationLabel\").attr(\"x\", function (d) {\n      return d.x + textOffset;\n    }).attr(\"y\", function (d) {\n      return d.y;\n    }).attr(\"fill\", \"black\").attr(\"text-anchor\", \"start\").attr(\"font-size\", textSize + \"pt\").attr(\"fill\", \"black\").attr(\"display\", function (d) {\n      return isLocTextShown ? \"block\" : \"none\";\n    }).text(function (d) {\n      return d.name;\n    }); // LAYOUT: SCATTER\n\n    if (layout === \"scatter\") {\n      // add simulation to it\n      forceSimulation(isolateDataClone) // create simulation for circles\n      .force(\"gravity\", forceManyBody().strength(-0.1)).force(\"collide\", forceCollide().radius(nodeSize).strength(0.3)).tick(50).stop(); //draw circle\n\n      circlesGroup.selectAll(\".localmap-circle\").data(isolateDataClone).enter().append(\"circle\").attr(\"class\", \"localmap-circle\").attr(\"r\", function (d) {\n        return nodeSize;\n      }).attr(\"stroke\", \"black\").attr(\"stroke-width\", \"1px\").style(\"opacity\", \"1\").style(\"display\", function (d) {\n        var loc_coord = props.data.locationTable.get(d.isolate_colLocation);\n\n        if (loc_coord) {\n          return \"block\";\n        } else {\n          return \"none\";\n        }\n      }).attr(\"cursor\", \"pointer\").attr(\"cx\", function (d) {\n        return d.x;\n      }).attr(\"cy\", function (d) {\n        return d.y;\n      }).attr(\"fill\", function (d) {\n        return getColorScaleByObject(d, props.colorScale);\n      }).on(\"click\", function (d) {\n        props.setSelectedData([d.uid]);\n      }).append(\"title\").text(function (d) {\n        return \"isolate: \".concat(d.isolate_name);\n      });\n    } // === LAYOUT: PIECHART ===\n    else {\n        var pieGenerator = pie().sort(null).value(function (d) {\n          return d[1].length;\n        });\n        var isolateDataGroupByLoc = group(isolateDataClone, function (d) {\n          return d.isolate_colLocation;\n        }); //make data input for pie chart\n\n        var locPieChartData = Array.from(locCoordMap.entries()); //locPieChartData = [0:[0:loc_name, 1:{locX: loc, locY: loc, data: dataByLocGroup}]]\n\n        locPieChartData.forEach(function (loc) {\n          var data = isolateDataGroupByLoc.get(loc[0]);\n\n          if (Array.isArray(data)) {\n            data = Array.from(group(data, function (d) {\n              return getColumnNameByColorType(d, props.colorScale.colorType);\n            }).entries());\n          }\n\n          loc[1][\"data\"] = data; //console.log(loc);\n        }); // 1. list of locations, with each location has data\n        // 2. this data is feed to pieGenetor\n        // make nodes group and draw nodes on it\n\n        var nodesGroup = svgGroup.append(\"g\").attr(\"id\", \"localmap_nodesGroup\"); //draw node circle\n\n        var pieGroup = nodesGroup.selectAll(\".localmap_pieGroup\").data(locPieChartData).enter().append(\"g\").attr(\"class\", \"localmap_pieGroup\").attr(\"transform\", function (d) {\n          return \"translate(\" + d[1].locX + \",\" + d[1].locY + \")\";\n        }).style(\"display\", function (d) {\n          var loc_coord = props.data.locationTable.get(d[0]);\n\n          if (loc_coord) {\n            return \"block\";\n          } else {\n            return \"none\";\n          }\n        });\n        var pieArcGroup = pieGroup.selectAll(\".localmap_pieArcGroup\").data(function (d) {\n          var res = d[1].data ? pieGenerator(d[1].data) : [null];\n          return res;\n        }).enter().append(\"g\").attr(\"class\", \"localmap_pieArcGroup\");\n        pieArcGroup.append(\"path\").attr(\"d\", function (d) {\n          if (d) {\n            var arcGenerator = arc().outerRadius(nodeSize).innerRadius(0);\n            return arcGenerator(d);\n          } else {\n            return \"none\";\n          }\n        }).style(\"fill\", function (d) {\n          if (d) {\n            var obj = d.data[1][0] ? d.data[1][0] : null;\n            var col = obj ? getColorScaleByObject(obj, props.colorScale) : \"black\";\n            return col;\n          } else {\n            return \"black\";\n          }\n        }).style(\"opacity\", function (d) {\n          return 1;\n        }).on(\"click\", function (d) {\n          var clickedData = d.data[1];\n          var clickedselectedData = [];\n\n          if (clickedData.length > 0) {\n            clickedData.forEach(function (d) {\n              clickedselectedData.push(d.uid);\n            });\n          }\n\n          props.setSelectedData(clickedselectedData);\n        }).append(\"title\").text(function (d) {\n          if (d) {\n            var percentage = ((d.endAngle - d.startAngle) / (2 * Math.PI) * 100).toFixed(2);\n            return d.data[0] + \" \" + percentage + \"%\";\n          } else {\n            return \"none\";\n          }\n        });\n      }\n\n    if (props.selectedData && props.selectedData.length > 0) {\n      updateBySelectedData();\n    } //zoom functionality\n\n\n    var zoomHandler = zoom().scaleExtent([0.1, 6]).on(\"zoom\", function () {\n      zoomStateRef.current = currentEvent.transform;\n      select(\"#localmap_svgGroup\").attr(\"transform\", currentEvent.transform);\n    }).filter(function () {\n      return !currentEvent.button && currentEvent.type !== \"wheel\";\n    }); //Zoom in button\n\n    container.select(\"#localmap-zoomIn\").on(\"click\", function () {\n      zoomHandler.scaleBy(svg.transition().duration(500), 1.5);\n    }); //Zoom out button\n\n    container.select(\"#localmap-zoomOut\").on(\"click\", function () {\n      zoomHandler.scaleBy(svg.transition().duration(500), 0.5);\n    });\n    svg.call(zoomHandler);\n  }\n\n  function updateBySelectedData() {\n    if (layout === \"scatter\") {\n      svg.selectAll(\".localmap-circle\").attr(\"r\", function (d) {\n        //console.log(selectedData, d);\n        if (props.selectedData.indexOf(d.uid) !== -1) {\n          return nodeSize * 1.5;\n        } else {\n          return nodeSize;\n        }\n      }).style(\"opacity\", function (d) {\n        if (props.selectedData.indexOf(d.uid) !== -1) {\n          return 0.9;\n        } else {\n          return 0.2;\n        }\n      });\n    } else {\n      svg.selectAll(\".localmap_pieArcGroup\").style(\"opacity\", function (d) {\n        var isolatesInSlice = d.data[1].map(function (d) {\n          return d.isolate_name;\n        });\n        var diff = isolatesInSlice.filter(function (n) {\n          return props.selectedData.indexOf(n) !== -1;\n        });\n\n        if (diff && diff.length > 0) {\n          return 0.8;\n        } else {\n          return 0.2;\n        }\n      });\n    }\n  }\n\n  function clearSelectedData() {\n    if (layout === \"scatter\") {\n      svg.selectAll(\".localmap-circle\").attr(\"r\", function (d) {\n        return nodeSize;\n      }).style(\"opacity\", function (d) {\n        return 0.8;\n      });\n    } else {\n      svg.selectAll(\".localmap_pieArcGroup\").style(\"opacity\", function (d) {\n        return 1;\n      });\n    }\n  } //HANDLERS\n\n\n  var clearSelectedDataHandler = function clearSelectedDataHandler() {\n    props.setSelectedData([]);\n  };\n\n  return /*#__PURE__*/React.createElement(React.Fragment, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 435,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    id: \"localmapContainer\",\n    ref: localmapContainerRef,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 436,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    id: \"localmap-no-drawing\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 437,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(Empty, {\n    description: \"No chart: please click redraw button\",\n    image: Empty.PRESENTED_IMAGE_SIMPLE,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 438,\n      columnNumber: 11\n    }\n  })), /*#__PURE__*/React.createElement(\"div\", {\n    id: \"localmap-buttons-container\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 443,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    id: \"localmap-zoom-buttons\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 444,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    title: \"Zoom in\",\n    shape: \"circle\",\n    id: \"localmap-zoomIn\",\n    size: \"medium\",\n    icon: /*#__PURE__*/React.createElement(ZoomInOutlined, {\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 450,\n        columnNumber: 21\n      }\n    }),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 445,\n      columnNumber: 13\n    }\n  }), /*#__PURE__*/React.createElement(Button, {\n    title: \"Zoom out\",\n    shape: \"circle\",\n    id: \"localmap-zoomOut\",\n    size: \"medium\",\n    icon: /*#__PURE__*/React.createElement(ZoomOutOutlined, {\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 457,\n        columnNumber: 21\n      }\n    }),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 452,\n      columnNumber: 13\n    }\n  }), /*#__PURE__*/React.createElement(Button, {\n    title: \"Clear selection\",\n    shape: \"circle\",\n    id: \"simulatedmap-clearSelection\",\n    size: \"medium\",\n    icon: /*#__PURE__*/React.createElement(ClearOutlined, {\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 464,\n        columnNumber: 21\n      }\n    }),\n    onClick: clearSelectedDataHandler,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 459,\n      columnNumber: 13\n    }\n  }))), /*#__PURE__*/React.createElement(\"div\", {\n    id: \"localmap-tooltip\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 469,\n      columnNumber: 9\n    }\n  }), /*#__PURE__*/React.createElement(\"svg\", {\n    id: \"localmap-svg\",\n    ref: localmapSVGRef,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 470,\n      columnNumber: 9\n    }\n  })));\n};\n\nexport default LocalmapChart;","map":{"version":3,"sources":["/Volumes/DATA/BUDI/APP_DEV/haiviz-v04/src/viz_Localmap/chart_Localmap_svg.js"],"names":["React","useEffect","useRef","select","arc","pie","group","zoom","event","currentEvent","Button","Empty","getColorScaleByObject","getColumnNameByColorType","ZoomInOutlined","ZoomOutOutlined","ClearOutlined","forceSimulation","forceCollide","forceManyBody","_","require","LocalmapChart","props","zoomStateRef","localmapSVGRef","localmapContainerRef","container","current","svg","observedWidth","width","observedHeight","height","margin","top","right","bottom","left","externalSVGnode","data","xmlSVG","cloneNode","setAttribute","container_w","container_h","isolateDataClone","cloneDeep","Array","from","isolateData","values","isUserStartResize","localmapSettings","nodeSize","textSize","textOffset","isLocTextShown","layout","isUserRedraw","draw","remove","style","selectedData","length","updateBySelectedData","clearSelectedData","colorScale","colorType","selectAll","attr","d","svgGroup","append","x","y","k","svgBaseGroup","node","appendChild","locCoordMap","Map","forEach","key","isolate_colLocation","loc_coord","locationTable","get","val","locX","locY","set","circlesGroup","enter","text","name","force","strength","radius","tick","stop","on","setSelectedData","uid","isolate_name","pieGenerator","sort","value","isolateDataGroupByLoc","locPieChartData","entries","loc","isArray","nodesGroup","pieGroup","pieArcGroup","res","arcGenerator","outerRadius","innerRadius","obj","col","clickedData","clickedselectedData","push","percentage","endAngle","startAngle","Math","PI","toFixed","zoomHandler","scaleExtent","transform","filter","button","type","scaleBy","transition","duration","call","indexOf","isolatesInSlice","map","diff","n","clearSelectedDataHandler","PRESENTED_IMAGE_SIMPLE"],"mappings":"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","sourcesContent":["/* ============================================================================\nNOTE: DONT PUT SIMULATION ON CONSTRUCTOR: it slows down resizing behaviour,\nput it on drawing function instead\n============================================================================ */\nimport React, { useEffect, useRef } from \"react\";\nimport { select } from \"d3-selection\";\nimport { arc, pie } from \"d3-shape\";\nimport { group } from \"d3-array\";\nimport { zoom } from \"d3-zoom\";\nimport { event as currentEvent } from \"d3\";\nimport { Button, Empty } from \"antd\";\nimport \"./style_Localmap.css\";\nimport {\n  getColorScaleByObject,\n  getColumnNameByColorType,\n} from \"../utils/utils\";\nimport {\n  ZoomInOutlined,\n  ZoomOutOutlined,\n  ClearOutlined,\n} from \"@ant-design/icons\";\nimport { forceSimulation, forceCollide, forceManyBody } from \"d3-force\";\n\nconst _ = require(\"lodash\");\n\n//props.data ={xmlsvg, data} svgMap props.height, props.width, props.locationData, props.setlocationData\nconst LocalmapChart = (props) => {\n  //INTERNAL STATES/REFS\n  const zoomStateRef = useRef(null);\n  const localmapSVGRef = useRef();\n  const localmapContainerRef = useRef();\n\n  //DRAWING CONSTRUCTOR\n  const container = select(localmapContainerRef.current);\n  const svg = select(localmapSVGRef.current);\n  const observedWidth = props.width - 10;\n  const observedHeight = props.height - 80;\n  const margin = { top: 10, right: 10, bottom: 10, left: 10 };\n  const externalSVGnode = props.data.xmlSVG.cloneNode(true);\n  externalSVGnode.setAttribute(\"id\", \"externalSVG\");\n  const container_w = observedWidth;\n  const container_h = observedHeight;\n  const isolateDataClone = _.cloneDeep(Array.from(props.isolateData.values()));\n\n  //SETTINGS\n  const isUserStartResize = props.localmapSettings.isUserStartResize;\n  const nodeSize = props.localmapSettings.nodeSize;\n  const textSize = props.localmapSettings.textSize;\n  const textOffset = props.localmapSettings.textOffset;\n  const isLocTextShown = props.localmapSettings.isLocTextShown;\n  const layout = props.localmapSettings.layout;\n\n  //HELPER FUNCTIONS\n\n  //USE EFFECTS\n  useEffect(() => {\n    if (\n      observedWidth &&\n      observedHeight &&\n      !isUserStartResize &&\n      !props.isUserRedraw\n    ) {\n      //when initial draw\n      draw();\n    } else if (\n      observedWidth &&\n      observedHeight &&\n      !isUserStartResize &&\n      props.isUserRedraw\n    ) {\n      //when user click redraw\n      draw();\n    } else {\n      select(\"#localmap_svgGroup\").remove();\n      select(\"#localmap-buttons-container\").style(\"display\", \"none\");\n      select(\"#localmap-no-drawing\").style(\"display\", \"block\");\n    }\n  }, [observedWidth, observedHeight, isUserStartResize, props.isUserRedraw]);\n  // === SELECTED DATA ===\n  useEffect(() => {\n    if (props.selectedData && props.selectedData.length > 0) {\n      updateBySelectedData();\n    } else if (props.selectedData && props.selectedData.length === 0) {\n      clearSelectedData();\n    }\n  }, [props.selectedData]);\n  // === COLORSCALE ===\n  useEffect(() => {\n    if (props.colorScale.colorType) {\n      if (layout === \"scatter\") {\n        svg\n          .selectAll(\".localmap-circle\")\n          .attr(\"fill\", (d) => getColorScaleByObject(d, props.colorScale));\n      } else {\n        draw();\n      }\n    }\n  }, [props.colorScale]);\n  // === NODE SIZE ===\n  useEffect(() => {\n    if (nodeSize) {\n      if (layout === \"scatter\") {\n        if (props.selectedData && props.selectedData.length > 0) {\n          svg.selectAll(\".localmap-circle\").attr(\"r\", (d) => nodeSize);\n          updateBySelectedData();\n        } else {\n          svg.selectAll(\".localmap-circle\").attr(\"r\", (d) => nodeSize);\n        }\n      } else {\n        draw();\n      }\n    }\n  }, [nodeSize]);\n  // === SHOW TEXT AND TEXT SIZE ===\n  useEffect(() => {\n    if (isLocTextShown && textSize) {\n      svg\n        .selectAll(\".localmap-locationLabel\")\n        .attr(\"display\", \"block\")\n        .attr(\"font-size\", (d) => textSize + \"pt\");\n    } else if (!isLocTextShown) {\n      svg.selectAll(\".localmap-locationLabel\").attr(\"display\", \"none\");\n    }\n  }, [isLocTextShown, textSize]);\n  // === SHOW TEXT AND TEXT OFFSETT ===\n  useEffect(() => {\n    if (isLocTextShown && textOffset) {\n      svg\n        .selectAll(\".localmap-locationLabel\")\n        .attr(\"display\", \"block\")\n        .attr(\"transform\", (d) => \"translate(\" + textOffset + \",\" + 0 + \")\");\n    } else if (!isLocTextShown) {\n      svg.selectAll(\".localmap-locationLabel\").attr(\"display\", \"none\");\n    }\n  }, [isLocTextShown, textOffset]);\n  // === LAYOUT ===\n  useEffect(() => {\n    if (layout) {\n      draw();\n    }\n  }, [layout]);\n\n  //DRAWING\n  function draw() {\n    const svg = select(localmapSVGRef.current);\n    //cleaning\n    select(\"#localmap-no-drawing\").style(\"display\", \"none\");\n    select(\"#localmap-buttons-container\").style(\"display\", \"block\");\n    select(\"#localmap_svgGroup\").remove();\n    //svg attributes\n    svg.attr(\"width\", container_w).attr(\"height\", container_h);\n    //make svg group root\n    let svgGroup = svg\n      .append(\"g\")\n      .attr(\"id\", \"localmap_svgGroup\")\n      .attr(\"transform\", function(d) {\n        if (zoomStateRef.current) {\n          return (\n            \"translate(\" +\n            zoomStateRef.current.x +\n            \",\" +\n            zoomStateRef.current.y +\n            \")\" +\n            \"scale(\" +\n            zoomStateRef.current.k +\n            \")\"\n          );\n        } else {\n          return `translate(${margin.left},${margin.top})scale(1)`;\n        }\n      });\n    //\"translate(\" + margin.left + \",\" + margin.top + \")\" + \"scale(1)\"\n    //inject externalSVG and scale it\n    let svgBaseGroup = svgGroup.append(\"g\").attr(\"id\", \"localmap-base-g\");\n    svgBaseGroup.node().appendChild(externalSVGnode);\n    //add location coordinates\n    const locCoordMap = new Map();\n    isolateDataClone.forEach((d) => {\n      let key = d.isolate_colLocation;\n      let loc_coord = props.data.locationTable.get(d.isolate_colLocation);\n      if (loc_coord) {\n        d[\"x\"] = loc_coord.x;\n        d[\"y\"] = loc_coord.y;\n      } else {\n        d[\"x\"] = 0;\n        d[\"y\"] = 0;\n      }\n      let val = {\n        locX: d.x,\n        locY: d.y,\n      };\n      locCoordMap.set(key, val);\n    });\n\n    let circlesGroup = svgGroup.append(\"g\").attr(\"id\", \"localmap-circle-g\");\n    //draw location label\n    circlesGroup\n      .selectAll(\".localmap-locationLabel\")\n      .data(Array.from(props.data.locationTable.values()))\n      .enter()\n      .append(\"text\")\n      .attr(\"class\", \"localmap-locationLabel\")\n      .attr(\"x\", (d) => d.x + textOffset)\n      .attr(\"y\", (d) => d.y)\n      .attr(\"fill\", \"black\")\n      .attr(\"text-anchor\", \"start\")\n      .attr(\"font-size\", textSize + \"pt\")\n      .attr(\"fill\", \"black\")\n      .attr(\"display\", (d) => (isLocTextShown ? \"block\" : \"none\"))\n      .text((d) => d.name);\n    // LAYOUT: SCATTER\n    if (layout === \"scatter\") {\n      // add simulation to it\n      forceSimulation(isolateDataClone) // create simulation for circles\n        .force(\"gravity\", forceManyBody().strength(-0.1))\n        .force(\n          \"collide\",\n          forceCollide()\n            .radius(nodeSize)\n            .strength(0.3)\n        )\n        .tick(50)\n        .stop();\n\n      //draw circle\n      circlesGroup\n        .selectAll(\".localmap-circle\")\n        .data(isolateDataClone)\n        .enter()\n        .append(\"circle\")\n        .attr(\"class\", \"localmap-circle\")\n        .attr(\"r\", (d) => nodeSize)\n        .attr(\"stroke\", \"black\")\n        .attr(\"stroke-width\", \"1px\")\n        .style(\"opacity\", \"1\")\n        .style(\"display\", (d) => {\n          let loc_coord = props.data.locationTable.get(d.isolate_colLocation);\n          if (loc_coord) {\n            return \"block\";\n          } else {\n            return \"none\";\n          }\n        })\n        .attr(\"cursor\", \"pointer\")\n        .attr(\"cx\", (d) => d.x)\n        .attr(\"cy\", (d) => d.y)\n        .attr(\"fill\", (d) => getColorScaleByObject(d, props.colorScale))\n        .on(\"click\", (d) => {\n          props.setSelectedData([d.uid]);\n        })\n        .append(\"title\")\n        .text((d) => `isolate: ${d.isolate_name}`);\n    }\n    // === LAYOUT: PIECHART ===\n    else {\n      const pieGenerator = pie()\n        .sort(null)\n        .value((d) => d[1].length);\n      const isolateDataGroupByLoc = group(\n        isolateDataClone,\n        (d) => d.isolate_colLocation\n      );\n      //make data input for pie chart\n      const locPieChartData = Array.from(locCoordMap.entries());\n      //locPieChartData = [0:[0:loc_name, 1:{locX: loc, locY: loc, data: dataByLocGroup}]]\n      locPieChartData.forEach((loc) => {\n        let data = isolateDataGroupByLoc.get(loc[0]);\n        if (Array.isArray(data)) {\n          data = Array.from(\n            group(data, (d) =>\n              getColumnNameByColorType(d, props.colorScale.colorType)\n            ).entries()\n          );\n        }\n        loc[1][\"data\"] = data;\n        //console.log(loc);\n      });\n\n      // 1. list of locations, with each location has data\n      // 2. this data is feed to pieGenetor\n      // make nodes group and draw nodes on it\n      let nodesGroup = svgGroup.append(\"g\").attr(\"id\", \"localmap_nodesGroup\");\n      //draw node circle\n      let pieGroup = nodesGroup\n        .selectAll(\".localmap_pieGroup\")\n        .data(locPieChartData)\n        .enter()\n        .append(\"g\")\n        .attr(\"class\", \"localmap_pieGroup\")\n        .attr(\n          \"transform\",\n          (d) => \"translate(\" + d[1].locX + \",\" + d[1].locY + \")\"\n        )\n        .style(\"display\", (d) => {\n          let loc_coord = props.data.locationTable.get(d[0]);\n          if (loc_coord) {\n            return \"block\";\n          } else {\n            return \"none\";\n          }\n        });\n\n      let pieArcGroup = pieGroup\n        .selectAll(\".localmap_pieArcGroup\")\n        .data((d) => {\n          let res = d[1].data ? pieGenerator(d[1].data) : [null];\n          return res;\n        })\n        .enter()\n        .append(\"g\")\n        .attr(\"class\", \"localmap_pieArcGroup\");\n\n      pieArcGroup\n        .append(\"path\")\n        .attr(\"d\", (d) => {\n          if (d) {\n            let arcGenerator = arc()\n              .outerRadius(nodeSize)\n              .innerRadius(0);\n            return arcGenerator(d);\n          } else {\n            return \"none\";\n          }\n        })\n        .style(\"fill\", (d) => {\n          if (d) {\n            let obj = d.data[1][0] ? d.data[1][0] : null;\n            let col = obj\n              ? getColorScaleByObject(obj, props.colorScale)\n              : \"black\";\n            return col;\n          } else {\n            return \"black\";\n          }\n        })\n        .style(\"opacity\", (d) => 1)\n        .on(\"click\", (d) => {\n          let clickedData = d.data[1];\n          let clickedselectedData = [];\n          if (clickedData.length > 0) {\n            clickedData.forEach((d) => {\n              clickedselectedData.push(d.uid);\n            });\n          }\n          props.setSelectedData(clickedselectedData);\n        })\n        .append(\"title\")\n        .text((d) => {\n          if (d) {\n            let percentage = (\n              ((d.endAngle - d.startAngle) / (2 * Math.PI)) *\n              100\n            ).toFixed(2);\n            return d.data[0] + \" \" + percentage + \"%\";\n          } else {\n            return \"none\";\n          }\n        });\n    }\n\n    if (props.selectedData && props.selectedData.length > 0) {\n      updateBySelectedData();\n    }\n\n    //zoom functionality\n    const zoomHandler = zoom()\n      .scaleExtent([0.1, 6])\n      .on(\"zoom\", () => {\n        zoomStateRef.current = currentEvent.transform;\n        select(\"#localmap_svgGroup\").attr(\"transform\", currentEvent.transform);\n      })\n      .filter(function() {\n        return !currentEvent.button && currentEvent.type !== \"wheel\";\n      });\n\n    //Zoom in button\n    container.select(\"#localmap-zoomIn\").on(\"click\", () => {\n      zoomHandler.scaleBy(svg.transition().duration(500), 1.5);\n    });\n    //Zoom out button\n    container.select(\"#localmap-zoomOut\").on(\"click\", () => {\n      zoomHandler.scaleBy(svg.transition().duration(500), 0.5);\n    });\n\n    svg.call(zoomHandler);\n  }\n  function updateBySelectedData() {\n    if (layout === \"scatter\") {\n      svg\n        .selectAll(\".localmap-circle\")\n        .attr(\"r\", (d) => {\n          //console.log(selectedData, d);\n          if (props.selectedData.indexOf(d.uid) !== -1) {\n            return nodeSize * 1.5;\n          } else {\n            return nodeSize;\n          }\n        })\n        .style(\"opacity\", (d) => {\n          if (props.selectedData.indexOf(d.uid) !== -1) {\n            return 0.9;\n          } else {\n            return 0.2;\n          }\n        });\n    } else {\n      svg.selectAll(\".localmap_pieArcGroup\").style(\"opacity\", (d) => {\n        let isolatesInSlice = d.data[1].map((d) => d.isolate_name);\n        let diff = isolatesInSlice.filter(function(n) {\n          return props.selectedData.indexOf(n) !== -1;\n        });\n        if (diff && diff.length > 0) {\n          return 0.8;\n        } else {\n          return 0.2;\n        }\n      });\n    }\n  }\n  function clearSelectedData() {\n    if (layout === \"scatter\") {\n      svg\n        .selectAll(\".localmap-circle\")\n        .attr(\"r\", (d) => nodeSize)\n        .style(\"opacity\", (d) => 0.8);\n    } else {\n      svg.selectAll(\".localmap_pieArcGroup\").style(\"opacity\", (d) => 1);\n    }\n  }\n  //HANDLERS\n  const clearSelectedDataHandler = () => {\n    props.setSelectedData([]);\n  };\n  return (\n    <React.Fragment>\n      <div id=\"localmapContainer\" ref={localmapContainerRef}>\n        <div id=\"localmap-no-drawing\">\n          <Empty\n            description={\"No chart: please click redraw button\"}\n            image={Empty.PRESENTED_IMAGE_SIMPLE}\n          />\n        </div>\n        <div id=\"localmap-buttons-container\">\n          <div id=\"localmap-zoom-buttons\">\n            <Button\n              title={\"Zoom in\"}\n              shape={\"circle\"}\n              id={\"localmap-zoomIn\"}\n              size={\"medium\"}\n              icon={<ZoomInOutlined />}\n            ></Button>\n            <Button\n              title={\"Zoom out\"}\n              shape={\"circle\"}\n              id={\"localmap-zoomOut\"}\n              size={\"medium\"}\n              icon={<ZoomOutOutlined />}\n            ></Button>\n            <Button\n              title={\"Clear selection\"}\n              shape={\"circle\"}\n              id={\"simulatedmap-clearSelection\"}\n              size={\"medium\"}\n              icon={<ClearOutlined />}\n              onClick={clearSelectedDataHandler}\n            ></Button>\n          </div>\n        </div>\n        <div id=\"localmap-tooltip\"></div>\n        <svg id=\"localmap-svg\" ref={localmapSVGRef}></svg>\n      </div>\n    </React.Fragment>\n  );\n};\n\nexport default LocalmapChart;\n"]},"metadata":{},"sourceType":"module"}